<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>古诗词互动手册 - AI 绘画版</title>
    <!-- 使用 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Google 字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- 引入 Lucide 图标 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'ui-sans-serif', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #020617;
            overflow-x: hidden;
        }
        .font-serif {
            font-family: 'Noto Serif SC', serif;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        @keyframes fall {
            to { transform: translateY(110vh) rotate(360deg); opacity: 0; }
        }
        @keyframes slow-zoom {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }
        .element {
            position: absolute;
            z-index: 25;
            animation: fall linear infinite;
            pointer-events: none;
        }
        .animate-slow-zoom {
            animation: slow-zoom 40s infinite alternate ease-in-out;
        }
    </style>
</head>
<body class="text-slate-100">
    <div id="root"></div>

    <!-- React 运行环境 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const apiKey = ""; // 运行时由环境提供或留空

        const POEMS_DATA = [
            {
                title: "四时田园杂兴",
                author: "范成大",
                dynasty: "宋",
                content: [
                    { text: "昼出耘田夜绩麻，", notes: "耘田：除去田间杂草。绩麻：把麻搓成线。" },
                    { text: "村庄儿女各当家。", notes: "当家：指各司其事，各管一行。" },
                    { text: "童孙未解供耕织，", notes: "未解：不懂得。供：从事。" },
                    { text: "也傍桑阴学种瓜。", notes: "傍：靠近。桑阴：桑树荫。" }
                ],
                translation: "白天锄地，晚上搓麻线，村里的男女老少都在忙碌。小孙子虽然不懂耕种织布，也学着大人的样子在桑树阴下种瓜。",
                visualPrompt: "Chinese rural village in Song Dynasty, golden afternoon sun through large mulberry leaves, a small child squatting on ground planting seeds, farmhouse in background, warm and peaceful atmosphere, Studio Ghibli style mixed with ink wash.",
                visualElements: ["桑阴学种瓜", "农家忙碌", "夏日午后"],
                effect: "leaves"
            },
            {
                title: "稚子弄冰",
                author: "杨万里",
                dynasty: "宋",
                content: [
                    { text: "稚子金盆脱晓冰，", notes: "晓：早晨。脱：脱出，取出。" },
                    { text: "彩丝穿取当银钲。", notes: "钲：古代乐器，这里指形状像钲的冰块。" },
                    { text: "敲成玉磬穿林响，", notes: "磬：打击乐器。" },
                    { text: "忽作玻璃碎地声。", notes: "玻璃：指玉石碎片。" }
                ],
                translation: "清晨，小孩从盆里取出冻冰，用彩线穿起来当作乐器敲，声音清亮。忽然冰块落地碎裂，响声如碎玉落地。",
                visualPrompt: "A little boy in ancient Chinese winter clothing, holding a circular ice plate with colorful string, frosty forest morning, morning mist, crystal clear ice reflecting sunlight, digital art style.",
                visualElements: ["彩丝穿冰", "清晨寒林", "冰碎瞬间"],
                effect: "snow"
            },
            {
                title: "村晚",
                author: "雷震",
                dynasty: "宋",
                content: [
                    { text: "草满池塘水满陂，", notes: "陂（bēi）：池岸。" },
                    { text: "山衔落日浸寒漪。", notes: "衔：口咬。漪：水波纹。" },
                    { text: "牧童归去横牛背，", notes: "横：横坐。" },
                    { text: "短笛无腔信口吹。", notes: "腔：曲调。信口：随口。" }
                ],
                translation: "池塘边长满青草，池水涨满。夕阳衔在山头，倒映在泛着寒意的波纹中。牧童横骑在牛背上归家，随口吹着不成调的短笛。",
                visualPrompt: "Sunset over a tranquil pond covered in green grass, distant mountains 'biting' the sun, reflection in the water, a shepherd boy sitting sideways on a water buffalo playing a flute, serene countryside evening, traditional Chinese painting style.",
                visualElements: ["山衔落日", "横坐牛背", "绿意池塘"],
                effect: "mist"
            },
            {
                title: "游子吟",
                author: "孟郊",
                dynasty: "唐",
                content: [
                    { text: "慈母手中线，", notes: "慈母：仁爱的母亲。" },
                    { text: "游子身上衣。", notes: "游子：出门远游的人。" },
                    { text: "临行密密缝，", notes: "临行：将要出门。" },
                    { text: "意恐迟迟归。", notes: "意恐：担心。迟迟：很晚。" },
                    { text: "谁言寸草心，", notes: "寸草：比喻子女。" },
                    { text: "报得三春晖。", notes: "晖：阳光。比喻母爱。" }
                ],
                translation: "慈祥的母亲手里拿着针线，给即将远行的儿子缝制衣服。她细细密密地缝着，担心儿子很晚才回来。谁说小草那点心意，能报答得了春天阳光般的慈母之爱呢？",
                visualPrompt: "Interior of an ancient Chinese house, dim candlelight, an old mother sewing a robe with focused expression, shadows on the wall, warm glowing light, emotional and nostalgic atmosphere, oil painting style.",
                visualElements: ["慈母缝衣", "烛光暖影", "三春晖意"],
                effect: "spark"
            },
            {
                title: "鸟鸣涧",
                author: "王维",
                dynasty: "唐",
                content: [
                    { text: "人闲桂花落，", notes: "闲：静。桂花：此指秋桂。" },
                    { text: "夜静春山空。", notes: "空：空旷。" },
                    { text: "月出惊山鸟，", notes: "惊：惊动。" },
                    { text: "时鸣春涧中。", notes: "时鸣：不时地啼叫。" }
                ],
                translation: "寂静的山中，桂花轻轻落下。静谧的春山显得格外空旷。明月升起惊动了山间的鸟儿，在春天的溪涧中不时发出啼叫。",
                visualPrompt: "Empty mountain at night, pale moonlight emerging from behind cliffs, tiny osmanthus flowers falling, deep valley with a stream, a few birds flying up in surprise, blue and silver tones, ethereal atmosphere.",
                visualElements: ["月出惊鸟", "桂花飘落", "幽静春山"],
                effect: "mist"
            },
            {
                title: "从军行",
                author: "王昌龄",
                dynasty: "唐",
                content: [
                    { text: "青海长云暗雪山，", notes: "暗：使...暗淡。" },
                    { text: "孤城遥望玉门关。", notes: "孤城：指边塞城堡。" },
                    { text: "黄沙百战穿金甲，", notes: "穿：磨穿。" },
                    { text: "不破楼兰终不还。", notes: "楼兰：古国名，代指敌军。" }
                ],
                translation: "青海湖上的长云遮暗了雪山，遥望孤城，远方就是玉门关。在漫天黄沙中身经百战磨穿了铠甲，不打败敌人誓不回还！",
                visualPrompt: "Vast desert, towering snow mountains in the distance under dark clouds, ancient fortress wall, golden armor reflecting cold light, sandstorm atmosphere, epic movie concept art.",
                visualElements: ["黄沙金甲", "暗淡雪山", "边关孤城"],
                effect: "sand"
            },
            {
                title: "秋夜将晓出篱门迎凉有感",
                author: "陆游",
                dynasty: "宋",
                content: [
                    { text: "三万里河东入海，", notes: "三万里河：指黄河。" },
                    { text: "五千仞岳上摩天。", notes: "五千仞岳：指华山。" },
                    { text: "遗民泪尽胡尘里，", notes: "遗民：指陷守区的百姓。胡尘：金兵铁骑扬起的尘土。" },
                    { text: "南望王师又一年。", notes: "王师：宋朝军队。" }
                ],
                translation: "三万里长的黄河奔腾入海，五千仞高的华山高耸入云。陷守区的百姓在金兵的铁骑下哭干了眼泪，南望宋朝军队收复失地又等了一年。",
                visualPrompt: "Mighty Yellow River rushing, giant peaks of Mount Hua piercing the sky, dramatic clouds, silhouette of people looking south in grief, grand but sorrowful landscape, historical fantasy style.",
                visualElements: ["河岳摩天", "悲愤遗民", "王师南望"],
                effect: "sand"
            },
            {
                title: "闻官军收河南河北",
                author: "杜甫",
                dynasty: "唐",
                content: [
                    { text: "剑外忽传收蓟北，", notes: "收：收复。" },
                    { text: "初闻涕泪满衣裳。", notes: "涕泪：狂喜的泪水。" },
                    { text: "白日放歌须纵酒，", notes: "纵酒：尽情喝酒。" },
                    { text: "青春作伴好还乡。", notes: "青春：春天。" },
                    { text: "即从巴峡穿巫峡，", notes: "穿：穿过。" },
                    { text: "便下襄阳向洛阳。", notes: "便下：随即直下。" }
                ],
                translation: "剑门关外忽然传来收复蓟北的消息，喜极而泣。在大好春光中纵情唱歌喝酒，回乡的路从巴峡穿过巫峡，顺流直下襄阳奔向洛阳。",
                visualPrompt: "Joyful scholar on a fast-moving wooden boat, lush green canyon cliffs of Wu Gorge, spring flowers blooming on banks, bright sun, energetic water splashes, vibrant colors.",
                visualElements: ["涕泪狂喜", "巴峡巫峡", "还乡快船"],
                effect: "confetti"
            },
            {
                title: "凉州词",
                author: "王之涣",
                dynasty: "唐",
                content: [
                    { text: "黄河远上白云间，", notes: "远上：远远向西望去。" },
                    { text: "一片孤城万仞山。", notes: "万仞山：形容山极高。" },
                    { text: "羌笛何须怨杨柳，", notes: "杨柳：指《折杨柳》曲。" },
                    { text: "春风不度玉门关。", notes: "不度：吹不过去。" }
                ],
                translation: "黄河远远流向白云深处，高耸的山峦间矗立着一座孤城。羌笛何必吹奏哀怨的《折杨柳》呢？春风原本就吹不过玉门关。",
                visualPrompt: "Aerial view of winding Yellow River leading to white clouds, a tiny fortress surrounded by massive jagged mountains, lonely soldier playing flute, vast wasteland, desolation and majesty, 8k cinematic.",
                visualElements: ["白云黄河", "孤城高山", "玉门关外"],
                effect: "sand"
            },
            {
                title: "黄鹤楼送孟浩然之广陵",
                author: "李白",
                dynasty: "唐",
                content: [
                    { text: "故人西辞黄鹤楼，", notes: "辞：辞别。" },
                    { text: "烟花三月下扬州。", notes: "烟花：指繁花似锦。" },
                    { text: "孤帆远影碧空尽，", notes: "尽：消失。" },
                    { text: "唯见长江天际流。", notes: "天际流：向天边流去。" }
                ],
                translation: "老朋友在黄鹤楼辞行，在柳絮如烟、繁花似锦的三月去往扬州。孤船的帆影远去消失在碧空尽头，只看见长江水向天边流去。",
                visualPrompt: "Magnificent Yellow Crane Tower on river bank, misty spring landscape, cherry blossoms and willows, a single sailboat on a huge river, vanishing into the horizon, soft morning light, watercolor ink style.",
                visualElements: ["烟花三月", "黄鹤送别", "孤帆远影"],
                effect: "river"
            },
            {
                title: "少年行（其一）",
                author: "王维",
                dynasty: "唐",
                content: [
                    { text: "新丰美酒斗十千，", notes: "斗十千：形容酒极名贵。" },
                    { text: "咸阳游侠多少年。", notes: "游侠：重义轻生的人。" },
                    { text: "相逢意气为君饮，", notes: "意气：志趣性格。" },
                    { text: "系马高楼垂柳边。", notes: "系：拴。" }
                ],
                translation: "名贵的新丰美酒一斗价值万钱，咸阳城里聚集着许多意气风发的少年。大家相逢投机尽情畅饮，马儿就拴在高楼外的垂柳边。",
                visualPrompt: "Vibrant ancient Chinese city tavern, young swordsmen in colorful silk robes, white horses tied to green willow trees outside, dynamic scene, laughter, sunlight through leaves, bright and heroic atmosphere.",
                visualElements: ["意气少年", "系马垂柳", "高楼美酒"],
                effect: "leaves"
            },
            {
                title: "赠花卿",
                author: "杜甫",
                dynasty: "唐",
                content: [
                    { text: "锦城丝管日纷纷，", notes: "锦城：成都。丝管：管弦乐。" },
                    { text: "半入江风半入云。", notes: "半入：形容音乐悠扬。" },
                    { text: "此曲只应天上有，", notes: "天上：仙境。" },
                    { text: "人间能得几回闻？", notes: "几回闻：听不到几次。" }
                ],
                translation: "成都城里管弦乐声终日不绝，悠扬的曲调一半随江风飘荡，一半飘入云端。这样的乐曲只应该天上才有，人间哪里能听到几次呢？",
                visualPrompt: "Dreamy ancient city Chengdu (Jincheng), swirling clouds and river wind, visible musical notes or golden particles in the air, celestial floating palace in the background, elegant and surreal, soft glow.",
                visualElements: ["锦城管弦", "仙乐入云", "江风悠扬"],
                effect: "spark"
            },
            {
                title: "江上",
                author: "王安石",
                dynasty: "宋",
                content: [
                    { text: "江北秋阴一半开，", notes: "秋阴：秋天的阴云。开：放晴。" },
                    { text: "晚云含雨却低徊。", notes: "低徊：徘徊，滞留。" },
                    { text: "青山缭绕疑无路，", notes: "缭绕：缠绕。" },
                    { text: "忽见千帆隐映来。", notes: "隐映：若隐若现。" }
                ],
                translation: "江北秋天的阴云刚散去一半，傍晚含雨的乌云低低飘荡。青山重重叠叠仿佛没有了路，忽然看见千万艘船帆若隐若现地驶来。",
                visualPrompt: "Moody river landscape, dark clouds low in the sky, misty mountains, many traditional sails appearing through the fog, dark turquoise and grey tones, ink wash aesthetic.",
                visualElements: ["秋阴晚云", "千帆隐映", "青山无路"],
                effect: "rain"
            },
            {
                title: "沈园（其一）",
                author: "陆游",
                dynasty: "宋",
                content: [
                    { text: "城上斜阳画角哀，", notes: "画角：古代军中乐器。哀：凄凉。" },
                    { text: "沈园非复旧池台。", notes: "非复：不再是。" },
                    { text: "伤心桥下春波绿，", notes: "春波绿：指当年相见的景象。" },
                    { text: "曾是惊鸿照影来。", notes: "惊鸿：指前妻唐婉。" }
                ],
                translation: "城墙上斜阳西下，传来凄凉的画角声，沈园已经不再是当年的亭台楼阁了。这伤心的桥下春水依然碧绿，这里曾映照过她那如惊鸿般轻盈的身影。",
                visualPrompt: "Melancholic ancient garden at sunset, a lonely stone bridge over green rippling water, fallen petals, soft warm light of sunset, silhouette of a scholar, shadow in the water, sadness and beauty.",
                visualElements: ["沈园斜阳", "伤心桥下", "惊鸿照影"],
                effect: "leaves"
            },
            {
                title: "冬夜读书示子聿",
                author: "陆游",
                dynasty: "宋",
                content: [
                    { text: "古人学问无遗力，", notes: "无遗力：用尽全身力气。" },
                    { text: "少壮工夫老始成。", notes: "少壮：年轻。成：成就。" },
                    { text: "纸上得来终觉浅，", notes: "终觉浅：终究觉得肤浅。" },
                    { text: "绝知此事要躬行。", notes: "绝知：透彻理解。躬行：亲身实践。" }
                ],
                translation: "古人做学问是不遗余力的，少年时的努力到老了才见成效。从书本上得到的知识终究是肤浅的，要透彻理解必须亲自去实践。",
                visualPrompt: "Ancient scholar study room, winter night, a young student reading by a flickering lamp, snow outside window, stacks of bamboo scrolls, inkstone and brush, warm interior light vs cold night, scholarly atmosphere.",
                visualElements: ["冬夜读书", "绝知躬行", "古人学问"],
                effect: "snow"
            },
            {
                title: "长相思",
                author: "白居易",
                dynasty: "唐",
                content: [
                    { text: "汴水流，泗水流，", notes: "汴水、泗水：水名。" },
                    { text: "流到瓜洲古渡头。", notes: "瓜洲：古渡口。" },
                    { text: "吴山点点愁。", notes: "吴山：指家乡的山。" },
                    { text: "思悠悠，恨悠悠，", notes: "悠悠：形容思念长远。" },
                    { text: "恨到归时方始休。", notes: "方始休：才算停止。" },
                    { text: "月明人倚楼。", notes: "倚楼：靠在楼上。" }
                ],
                translation: "汴水在流，泗水在流，一直流到瓜洲渡口。远处的吴山点点，仿佛满含离愁。思念绵绵，遗憾深深，直到你归来那天才会停止。明月下，我独自倚在高楼上。",
                visualPrompt: "Night scene of a quiet river ferry, bright full moon, a woman in long robe leaning against an ancient balcony railing, distant mountain peaks, reflection of moon in river, melancholic indigo blue palette.",
                visualElements: ["月明倚楼", "汴水流长", "思悠悠"],
                effect: "mist"
            },
            {
                title: "寄扬州韩绰判官",
                author: "杜牧",
                dynasty: "唐",
                content: [
                    { text: "青山隐隐水迢迢，", notes: "隐隐：模糊。迢迢：遥远。" },
                    { text: "秋尽江南草未凋。", notes: "秋尽：深秋。凋：枯萎。" },
                    { text: "二十四桥明月夜，", notes: "二十四桥：扬州名胜。" },
                    { text: "玉人何处教吹箫？", notes: "玉人：指韩绰。教：教导，听取。" }
                ],
                translation: "青山模糊，水路遥远，深秋的江南草木还没凋零。在这二十四桥明月映照的夜晚，你又在哪里教人吹奏玉箫呢？",
                visualPrompt: "Magical night in Yangzhou, a white stone bridge with a single arch, silver moonlight, willows over the river, glowing lanterns, a figure playing a vertical flute (Xiao), poetic and beautiful, purple and blue night sky.",
                visualElements: ["二十四桥", "明月夜", "玉人吹箫"],
                effect: "mist"
            },
            {
                title: "乡村四月",
                author: "翁卷",
                dynasty: "宋",
                content: [
                    { text: "绿遍山原白满川，", notes: "山原：山陵高原。川：平川。" },
                    { text: "子规声里雨如烟。", notes: "子规：杜鹃鸟。雨如烟：细雨蒙蒙。" },
                    { text: "乡村四月闲人少，", notes: "闲人少：都在忙农活。" },
                    { text: "才了蚕桑又插田。", notes: "才了：刚结束。插田：插秧。" }
                ],
                translation: "山原一片翠绿，河面水光映天。在杜鹃鸟的啼叫声中，细雨如烟雾般落下。乡村的四月没有人闲着，刚忙完采桑养蚕，又要去田里插秧。",
                visualPrompt: "Vibrant green rice paddies, light misty rain in spring, mountains covered in lush forest, farmers in conical hats planting rice, white mist over the river, peaceful and busy village scene, green and white color palette.",
                visualElements: ["子规雨烟", "绿遍山原", "蚕桑插田"],
                effect: "rain"
            },
            {
                title: "西江月·题溧阳三塔寺",
                author: "张孝祥",
                dynasty: "宋",
                content: [
                    { text: "问讯湖边春色，", notes: "问讯：打听。" },
                    { text: "重来又是三年。", notes: "重来：再次到来。" },
                    { text: "东风吹我过湖船，", notes: "东风：春风。" },
                    { text: "杨柳丝丝拂面。", notes: "拂面：轻碰脸颊。" },
                    { text: "世路如今已惯，", notes: "世路：世态人情。" },
                    { text: "此心到处悠然。", notes: "悠然：悠闲自在。" },
                    { text: "寒光亭下水如天，", notes: "水如天：水天一色。" },
                    { text: "飞起沙鸥一片。", notes: "沙鸥：水鸟。" }
                ],
                translation: "打听湖边的春色，三年来我又一次来到这里。春风吹着小船划过湖面，杨柳丝丝拂过我的脸庞。世间的人情冷暖早已习惯，此刻心情到处都悠然自在。寒光亭下的湖水与天一色，惊起一片洁白的沙鸥。",
                visualPrompt: "Ancient Chinese lakeside pavilion, crystal clear water reflecting the blue sky, willow trees by the shore, a small boat on the lake, a flock of white gulls flying up, bright and airy atmosphere, calm and relaxed vibe.",
                visualElements: ["水如天", "飞起沙鸥", "悠然此心"],
                effect: "river"
            },
            {
                title: "虞美人·听雨",
                author: "蒋捷",
                dynasty: "宋",
                content: [
                    { text: "少年听雨歌楼上，", notes: "少年：指年轻时。" },
                    { text: "红烛昏罗帐。", notes: "昏：暗淡。罗帐：丝织帐幕。" },
                    { text: "壮年听雨客舟中，", notes: "壮年：漂泊的船。" },
                    { text: "江阔云低、断雁叫西风。", notes: "断雁：失群的孤雁。" },
                    { text: "而今听雨僧庐下，", notes: "僧庐：僧舍。" },
                    { text: "鬓已星星也。", notes: "星星：鬓发花白。" },
                    { text: "悲欢离合总无情，", notes: "总无情：都是命中注定。" },
                    { text: "一任阶前、点滴到天明。", notes: "一任：任凭。阶前：台阶前。" }
                ],
                translation: "少年时在歌楼上听雨，红烛昏暗；壮年时在客船中听雨，江面辽阔云层低垂，孤雁在寒风中哀鸣；而现在，在简陋的僧庐下听雨，两鬓已经斑白。人生的悲欢离合总是冷酷无情，任凭台阶前的雨滴，一直滴到天亮。",
                visualPrompt: "Triple exposure concept art representing three stages of life: 1. Warm red glowing tavern, 2. Stormy grey river with a small boat and a single goose, 3. Old man in grey robe at a temple porch under night rain. Dramatic, cinematic, emotional storytelling.",
                visualElements: ["歌楼红烛", "江阔断雁", "僧庐鬓白"],
                effect: "rain"
            }
        ];

        const App = () => {
            const [currentIndex, setCurrentIndex] = useState(0);
            const [showTranslation, setShowTranslation] = useState(false);
            const [activeNote, setActiveNote] = useState(null);
            const [isImageOpen, setIsImageOpen] = useState(false);
            const [generatedImages, setGeneratedImages] = useState({});
            const [loadingImage, setLoadingImage] = useState(false);
            const [completed, setCompleted] = useState({});

            const currentPoem = POEMS_DATA[currentIndex];

            const generateAiImage = async (index) => {
                if (generatedImages[index]) return;
                setLoadingImage(true);
                try {
                    // 只有当 API Key 存在时才调用真实接口
                    if (apiKey) {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                instances: [{ prompt: POEMS_DATA[index].visualPrompt }],
                                parameters: { sampleCount: 1 }
                            })
                        });
                        const result = await response.json();
                        if (result.predictions?.[0]) {
                            const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                            setGeneratedImages(prev => ({ ...prev, [index]: imageUrl }));
                        }
                    } else {
                        // 兜底模拟逻辑（用于演示）
                        setTimeout(() => {
                            setGeneratedImages(prev => ({ 
                                ...prev, 
                                [index]: `https://images.unsplash.com/photo-1548504769-900b700126c6?auto=format&fit=crop&q=80&w=1200&h=1200&sig=${index}` 
                            }));
                        }, 1000);
                    }
                } catch (error) {
                    console.error("AI Generation Error", error);
                } finally {
                    setLoadingImage(false);
                }
            };

            useEffect(() => { 
                generateAiImage(currentIndex); 
                // 初始化 Lucide 图标
                if (window.lucide) window.lucide.createIcons();
            }, [currentIndex]);

            const RenderEffect = ({ type }) => (
                <div className="absolute inset-0 pointer-events-none overflow-hidden z-20">
                    {Array.from({ length: 15 }).map((_, i) => (
                        <div key={i} className="element" style={{
                            left: `${Math.random() * 100}%`,
                            top: `-${Math.random() * 20}%`,
                            animationDelay: `${Math.random() * 5}s`,
                            animationDuration: `${8 + Math.random() * 5}s`,
                            opacity: 0.4
                        }}>
                            {type === 'leaves' && <div className="w-5 h-2 bg-emerald-600 rounded-full rotate-45" />}
                            {type === 'snow' && <div className="w-1.5 h-1.5 bg-white rounded-full blur-[1px]" />}
                            {type === 'sand' && <div className="w-4 h-1 bg-amber-600/30 rounded-full" />}
                            {type === 'spark' && <div className="w-1 h-6 bg-yellow-400 animate-pulse" />}
                            {type === 'rain' && <div className="w-[1px] h-6 bg-sky-200 opacity-40" />}
                            {type === 'mist' && <div className="w-20 h-10 bg-white/5 blur-xl rounded-full" />}
                        </div>
                    ))}
                </div>
            );

            return (
                <div className="min-h-screen bg-[#020617] flex flex-col items-center justify-center p-4 font-sans text-slate-100 overflow-hidden">
                    {/* Header */}
                    <div className="w-full max-w-6xl mb-4 flex justify-between items-center px-4">
                        <div className="flex items-center gap-4">
                            <div className="bg-indigo-600 p-2 rounded-xl shadow-lg shadow-indigo-500/30">
                                <i data-lucide="trophy" class="w-5 h-5 text-white"></i>
                            </div>
                            <div>
                                <h2 className="text-sm font-black tracking-widest text-white uppercase italic">五年级必背古诗词(20首)</h2>
                                <div className="flex gap-1 mt-1">
                                    {POEMS_DATA.map((_, i) => (
                                        <div key={i} className={`h-1 w-2 rounded-full ${completed[i] ? 'bg-emerald-400' : i === currentIndex ? 'bg-indigo-500 w-4' : 'bg-white/10'}`} />
                                    ))}
                                </div>
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            <span className="text-[10px] text-white/40 font-bold uppercase">解锁进度: {Object.keys(completed).length}/20</span>
                        </div>
                    </div>

                    {/* Main Container */}
                    <div className="w-full max-w-6xl lg:h-[70vh] bg-slate-900 rounded-[2rem] border border-white/10 shadow-2xl overflow-hidden flex flex-col lg:flex-row relative">
                        {/* Artwork Area */}
                        <div onClick={() => setIsImageOpen(true)} className="w-full lg:w-1/2 h-[300px] lg:h-full relative overflow-hidden group cursor-pointer">
                            {loadingImage && !generatedImages[currentIndex] ? (
                                <div className="absolute inset-0 flex flex-col items-center justify-center bg-slate-900 z-50">
                                    <div className="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                                    <p className="text-indigo-400 text-xs font-bold animate-pulse">AI 意境绘图中...</p>
                                </div>
                            ) : (
                                <div className="h-full w-full">
                                    <img src={generatedImages[currentIndex] || `https://images.unsplash.com/photo-1548504769-900b700126c6?auto=format&fit=crop&q=80&w=1200&h=1200&sig=${currentIndex}`} className="w-full h-full object-cover brightness-[0.6] group-hover:scale-105 transition-transform duration-[10s]" />
                                    <div className="absolute inset-0 bg-gradient-to-t from-slate-950 via-transparent to-black/30 z-10" />
                                    <RenderEffect type={currentPoem.effect} />
                                    <div className="absolute inset-0 flex flex-col justify-center items-center text-white z-40 p-8 text-center pointer-events-none">
                                        <h1 className="text-4xl md:text-6xl font-serif font-black tracking-tighter drop-shadow-2xl">{currentPoem.title}</h1>
                                        <div className="mt-4 px-6 py-2 bg-white/10 backdrop-blur-md rounded-full border border-white/10 text-sm italic">{currentPoem.dynasty} · {currentPoem.author}</div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Content Area */}
                        <div className="w-full lg:w-1/2 p-8 lg:p-12 flex flex-col bg-slate-950 overflow-y-auto">
                            <div className="flex-grow flex flex-col justify-center space-y-4">
                                {currentPoem.content.map((line, idx) => (
                                    <div key={idx}>
                                        <p className={`text-3xl md:text-4xl font-serif cursor-pointer transition-colors ${activeNote === line.notes ? 'text-indigo-400' : 'text-slate-200 hover:text-indigo-300'}`} onClick={() => setActiveNote(activeNote === line.notes ? null : line.notes)}>{line.text}</p>
                                        {activeNote === line.notes && <div className="mt-2 p-3 bg-indigo-500/10 rounded-xl border-l-4 border-indigo-500 text-indigo-200 text-sm">{line.notes}</div>}
                                    </div>
                                ))}
                                
                                <div className="grid grid-cols-2 gap-3 pt-6">
                                    <button onClick={() => setShowTranslation(!showTranslation)} className={`py-4 rounded-xl border transition-all flex justify-center items-center ${showTranslation ? 'bg-indigo-600 border-indigo-500' : 'bg-white/5 border-white/10 text-slate-400'}`}>
                                        <i data-lucide="book-open" class="w-5 h-5"></i>
                                    </button>
                                    <button onClick={() => setCompleted(p => ({...p, [currentIndex]: !p[currentIndex]}))} className={`py-4 rounded-xl border transition-all flex justify-center items-center ${completed[currentIndex] ? 'bg-emerald-600 border-emerald-500' : 'bg-white/5 border-white/10 text-slate-400'}`}>
                                        <i data-lucide="shield" class="w-5 h-5"></i>
                                    </button>
                                </div>
                                {showTranslation && <div className="p-4 bg-indigo-950/30 rounded-xl border border-white/5 text-indigo-100 text-base italic leading-relaxed text-center">{currentPoem.translation}</div>}
                            </div>
                        </div>
                    </div>

                    {/* Pagination */}
                    <div className="mt-6 w-full max-w-6xl px-4 flex items-center gap-2 overflow-x-auto no-scrollbar py-2">
                        <button onClick={() => setCurrentIndex(p => (p - 1 + 20) % 20)} className="p-3 bg-white/5 rounded-xl border border-white/10 text-white/50 hover:text-white transition-colors">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i>
                        </button>
                        {POEMS_DATA.map((p, i) => (
                            <button key={i} onClick={() => setCurrentIndex(i)} className={`shrink-0 w-10 h-10 rounded-xl border text-[10px] font-bold transition-all ${currentIndex === i ? 'bg-indigo-600 text-white scale-110 shadow-lg shadow-indigo-500/20' : 'bg-white/5 border-white/10 text-white/30 hover:text-white/60'}`}>{i + 1}</button>
                        ))}
                        <button onClick={() => setCurrentIndex(p => (p + 1) % 20)} className="p-3 bg-white/5 rounded-xl border border-white/10 text-white/50 hover:text-white transition-colors">
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </div>

                    {/* Modal Overlay */}
                    {isImageOpen && (
                        <div className="fixed inset-0 z-[100] bg-slate-950 flex flex-col items-center justify-center animate-in fade-in">
                            <button onClick={() => setIsImageOpen(false)} className="absolute top-8 right-8 p-4 bg-white/10 text-white rounded-full z-[120] hover:bg-red-500 transition-colors">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                            <div className="relative w-full h-full flex items-center justify-center">
                                <RenderEffect type={currentPoem.effect} />
                                <img src={generatedImages[currentIndex]} className="w-full h-full object-cover brightness-[0.25] animate-slow-zoom" />
                                <div className="absolute inset-0 flex flex-col items-center justify-center text-center p-6 space-y-6">
                                    <i data-lucide="sparkles" class="w-12 h-12 text-indigo-400 opacity-50 animate-bounce"></i>
                                    <h2 className="text-white text-5xl md:text-8xl font-serif font-black drop-shadow-2xl">{currentPoem.title}</h2>
                                    <div className="flex gap-8 text-indigo-400/60 font-bold tracking-[0.4em] text-xs uppercase">
                                        {currentPoem.visualElements.map((e, idx) => <span key={idx}>{e}</span>)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
